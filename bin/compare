#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace DocteurKlein\ProfAnalyze;

$repo = require(__DIR__.'/factory.php');

$old = $argv[1];
$new = $argv[2];
$what = explode(',', $argv[3] ?? 'wt');
$threshold = intval($argv[4] ?? 0);

$records = $repo->compare($old, $new, $threshold);

echo 'digraph {';

foreach ($records as $record) {
    $caller = $record->get('caller');
    $callee = $record->get('callee');
    printf('%s [label="%s"];%s', $caller->identity(), addslashes($caller->name), "\n");
    printf('%s [label="%s"];%s', $callee->identity(), addslashes($callee->name), "\n");
    $from = $record->get('from_stats');
    $to = $record->get('to_stats');
    foreach ($what as $key) {
        $diff = $to->$key - $from->$key;
        $ratio = $diff < 0 ? $from->$key / $to->$key : $to->$key / $from->$key;
        $formatted = map[$key]($diff, true);

        vprintf('%s -> %s [label="%s%s",color="%s",fontsize="%s"];%s', [
            $caller->identity(),
            $callee->identity(),
            $formatted,
            $ratio > 1 ? sprintf(' (x%.2f)', $ratio) : '',
            $diff < 0 ? 'green' : ($diff == 0 ? '' : 'red'),
            $ratio > 2 ? '30' : '14',
            "\n"
        ]);
    }
}

echo '}';
